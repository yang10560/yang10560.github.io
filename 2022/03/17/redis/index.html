<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="缓存数据库redis"><meta name="keywords" content="redis"><meta name="author" content="夜雨"><meta name="copyright" content="夜雨"><title>缓存数据库redis | 夜雨小屋</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.1"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?4925a5b02da9504aab1a241aad222dfd";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://v1.hitokoto.cn/?encode=js&amp;charset=utf-8&amp;select=.footer_custom_text" defer></script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  hexoVersion: '6.3.0'
} </script><meta name="generator" content="Hexo 6.3.0"></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis"><span class="toc-number">1.</span> <span class="toc-text">Redis</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%89%B9%E6%80%A7"><span class="toc-number">1.1.</span> <span class="toc-text">特性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis%E5%85%B8%E5%9E%8B%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">1.2.</span> <span class="toc-text">Redis典型应用场景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-number">1.3.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5"><span class="toc-number">1.4.</span> <span class="toc-text">连接</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4"><span class="toc-number">1.5.</span> <span class="toc-text">命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">1.6.</span> <span class="toc-text">数据结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#string"><span class="toc-number">1.7.</span> <span class="toc-text">string</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#hash"><span class="toc-number">1.8.</span> <span class="toc-text">hash</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#list"><span class="toc-number">1.9.</span> <span class="toc-text">list</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#set"><span class="toc-number">1.10.</span> <span class="toc-text">set</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#zset"><span class="toc-number">1.11.</span> <span class="toc-text">zset</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Jedis-x2F-Jedispool"><span class="toc-number">1.12.</span> <span class="toc-text">Jedis&#x2F;Jedispool</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%85%A2%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.13.</span> <span class="toc-text">慢查询</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pipeline"><span class="toc-number">1.14.</span> <span class="toc-text">pipeline</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85"><span class="toc-number">1.15.</span> <span class="toc-text">发布订阅</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Bitmap"><span class="toc-number">1.16.</span> <span class="toc-text">Bitmap</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#hyperloglog"><span class="toc-number">1.17.</span> <span class="toc-text">hyperloglog</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#geo"><span class="toc-number">1.18.</span> <span class="toc-text">geo</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">1.19.</span> <span class="toc-text">持久化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fork-%E6%93%8D%E4%BD%9C"><span class="toc-number">1.20.</span> <span class="toc-text">fork 操作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="toc-number">1.21.</span> <span class="toc-text">主从复制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#redis-sentinel"><span class="toc-number">1.22.</span> <span class="toc-text">redis sentinel</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#redis-cluster"><span class="toc-number">1.23.</span> <span class="toc-text">redis cluster</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#jediscluster"><span class="toc-number">1.24.</span> <span class="toc-text">jediscluster</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E4%BD%BF%E7%94%A8%E5%92%8C%E4%BC%98%E5%8C%96"><span class="toc-number">2.</span> <span class="toc-text">缓存使用和优化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F"><span class="toc-number">2.1.</span> <span class="toc-text">缓存穿透</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%AA%E5%B4%A9"><span class="toc-number">2.2.</span> <span class="toc-text">雪崩</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A0%E5%BA%95%E6%B4%9E"><span class="toc-number">2.3.</span> <span class="toc-text">无底洞</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%83%AD%E7%82%B9key%E9%87%8D%E6%96%B0%E9%97%AE%E9%A2%98"><span class="toc-number">2.4.</span> <span class="toc-text">热点key重新问题</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E8%A7%84%E8%8C%83"><span class="toc-number">3.</span> <span class="toc-text">设计规范</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Key%E5%90%8D%E8%AE%BE%E8%AE%A1"><span class="toc-number">3.1.</span> <span class="toc-text">Key名设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%8F%AF%E8%AF%BB%E6%80%A7%E5%92%8C%E5%8F%AF%E7%AE%A1%E7%90%86%E6%80%A7"><span class="toc-number">3.2.</span> <span class="toc-text">1 可读性和可管理性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E7%AE%80%E6%B4%81%E6%80%A7"><span class="toc-number">3.3.</span> <span class="toc-text">2简洁性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E4%B8%8D%E8%A6%81%E5%8C%85%E5%90%AB%E7%89%B9%E6%AE%8A%E5%AD%97%E7%AC%A6"><span class="toc-number">3.4.</span> <span class="toc-text">3不要包含特殊字符</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Value%E8%AE%BE%E8%AE%A1"><span class="toc-number">3.5.</span> <span class="toc-text">Value设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E6%8B%92%E7%BB%9Dbigkey"><span class="toc-number">3.5.1.</span> <span class="toc-text">1拒绝bigkey</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E9%80%89%E6%8B%A9%E5%90%88%E9%80%82%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">3.5.2.</span> <span class="toc-text">2选择合适的数据结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E8%BF%87%E6%9C%9F%E8%AE%BE%E8%AE%A1"><span class="toc-number">3.5.3.</span> <span class="toc-text">3过期设计</span></a></li></ol></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="http://q.qlogo.cn/headimg_dl?dst_uin=29491242&amp;spec=640&amp;img_type=jpg"></div><div class="author-info__name text-center">夜雨</div><div class="author-info__description text-center">技术分享博客</div><div class="follow-button"><a target="_blank" rel="noopener" href="https://api.vvhan.com/api/qqChat?qq=29491242">联系QQ</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">7</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">9</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">友链</div><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://molunerfinn.com">Molunerfinn</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://piegg.cn">PiEgg</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://www.google.com">Google</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://s1.ax1x.com/2023/01/10/pSmKTYT.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">夜雨小屋</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">主页</a><a class="site-page" href="/archives">归档</a><a class="site-page" href="/tags">标签</a><a class="site-page" href="/categories">分类</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a></span></div><div id="post-info"><div id="post-title">缓存数据库redis</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-03-17</time><span class="post-meta__separator">|</span><i class="fa fa-comment-o post-meta__icon" aria-hidden="true"></i><a href="/2022/03/17/redis/#disqus_thread"><span class="disqus-comment-count" data-disqus-identifier="2022/03/17/redis/"></span></a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h1><h2 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h2><p>1.速度快 (基于内存)</p>
<p>10w OPS</p>
<p>单线程 (非阻塞IO)</p>
<p>2.持久化 </p>
<p>Redis所有数据保持在内存中，对数据的更新将异步地保存到磁盘上。</p>
<p>方式RDB,AOF</p>
<p>3.多数据结构 </p>
<p>string list hash set zset  </p>
<p>bitmap 位图（0，1）</p>
<p>HyperLogLog 超小内存唯一值计数</p>
<p>GEO：地理信息定位</p>
<p>4.支持多语言 </p>
<p>java php ruby  nodejs …</p>
<p>5.功能丰富</p>
<p>发布订阅 Lua脚本  事务  pipeline</p>
<p>6.主从复复制</p>
<p>7.高可用 分布式</p>
<h2 id="Redis典型应用场景"><a href="#Redis典型应用场景" class="headerlink" title="Redis典型应用场景"></a>Redis典型应用场景</h2><p>缓存系统</p>
<p>排行榜<br>计数器<br>社交网络<br>消息队列系统<br>实时系统</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">linux</span></span><br><span class="line">wget http://download.redis.io/releases/redis-3.0.7.tar.gz</span><br><span class="line">tar -xzf redis-3.0.7.tar.gz</span><br><span class="line">ln -s redis-3.0.7 redis</span><br><span class="line">cd redis</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<h2 id="连接"><a href="#连接" class="headerlink" title="连接"></a>连接</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h 10.10.79.150 -p 6384</span><br></pre></td></tr></table></figure>

<h2 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h2><p>keys [pattern]</p>
<p>dbszie</p>
<p>exists key </p>
<p>del key</p>
<p>expire key second</p>
<p>type key</p>
<p>ttl key (-2 key不存,-1存在但没有设置时间)</p>
<p>persist key </p>
<h2 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h2><p><img src="/upload/pics/p1.png"></p>
<h2 id="string"><a href="#string" class="headerlink" title="string"></a>string</h2><p>上限512M </p>
<p>缓存 计数 分布式锁</p>
<p>get&#x2F;set&#x2F;del&#x2F;incr&#x2F;decr&#x2F;incrby&#x2F;decrby</p>
<p>记录网站每个用户个人主页的访问量?</p>
<p> incr userid:pageview(单线程∶无竞争)</p>
<p>缓存视频的基本信息（数据源在MySQL中)伪代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> VideoInfo <span class="title function_">get</span><span class="params">(<span class="type">long</span> id)</span> &#123;</span><br><span class="line"><span class="type">String</span> <span class="variable">redisKey</span> <span class="operator">=</span> redisPrefix + id;</span><br><span class="line"><span class="type">VideoInfo</span> <span class="variable">videoInfo</span> <span class="operator">=</span> redis.get(redisKey);</span><br><span class="line">    <span class="keyword">if</span> (videoInfo == <span class="literal">null</span>) &#123;</span><br><span class="line">	videoInfo = mysql.get(id);</span><br><span class="line">        <span class="keyword">if</span> (videoInfo != <span class="literal">null</span>)&#123;</span><br><span class="line">		<span class="comment">//序列化</span></span><br><span class="line">		redis.set(redisKey, serialize(videoInfo));&#125;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="keyword">return</span> videoInfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>分布式id生成器   </p>
<p> incr id(原子操作)</p>
<p>set </p>
<p>setnx 不存在，才设置  </p>
<p>setxx  存在，才设置</p>
<p>mget&#x2F;mset  多值设置</p>
<p>getset key newvaule  设置新值返回旧值</p>
<p>append key value 追加到旧值</p>
<p>strlen key </p>
<p>getrange from to</p>
<h2 id="hash"><a href="#hash" class="headerlink" title="hash"></a>hash</h2><p><img src="/upload/pics/p2.png"></p>
<p>hget key field</p>
<p>hset key field val</p>
<p>hdel key field</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; hset user:1:info age 23</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; hget user:1:info age<span class="string">&quot;23&quot;</span></span><br><span class="line">127.0.0.1:6379&gt;hset user:1:info name ronaldo</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; hgetall user:1:info1) </span><br><span class="line"><span class="string">&quot;age&quot;</span></span><br><span class="line"><span class="string">&quot;23&quot;</span></span><br><span class="line"><span class="string">&quot;name&quot;</span></span><br><span class="line"><span class="string">&quot;ronaldo&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; hdel user:1:info age</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; hgetall user:1:info1)</span><br><span class="line"><span class="string">&quot;name&quot;</span></span><br><span class="line"><span class="string">&quot;ronaldo&quot;</span></span><br></pre></td></tr></table></figure>

<p>hexist key field</p>
<p>hlen key</p>
<p>hmget key field1,field2….</p>
<p>hmset key field1 value1 field2 value2…fieldN valueN</p>
<p>hgetall key</p>
<p>hvals key 返回key所有val</p>
<p>hkeys 返回key所有filed</p>
<p>记录网站每个用户个人主页的访问量?</p>
<p>hincrby user:1:info pageview count</p>
<h2 id="list"><a href="#list" class="headerlink" title="list"></a>list</h2><p>有序 重复 左右传输</p>
<p>rpush key val1 val2….</p>
<p> lpush</p>
<p>linsert key before|after value newvalue 在value 前|后 插入新值newvalue </p>
<p>lpop &#x2F;rpop</p>
<p>lrem key count value<br>#根据count值，从列表中删除所有value相等的项</p>
<p>(1) count&gt;0，从左到右，删除最多count个value相等的项<br>(2) count&lt;0，从右到左，删除最多Math.abs(count)个value相等的项</p>
<p>(3) count&#x3D;O，删除所有value相等的项</p>
<p>ltrim key start end</p>
<p>lrange key start end</p>
<p>lset key index newValue<br>#设置列表指定索引值为newValue</p>
<p>blpop key timeout<br>#lpop阻塞版本, timeout是阻塞超时时间,timeout&#x3D;0为永远不阻塞</p>
<p>brpop key timeout</p>
<h2 id="set"><a href="#set" class="headerlink" title="set"></a>set</h2><p>无序 不重复</p>
<p>sadd key element 。。。</p>
<p>srem key element 。。。</p>
<p>scard 集合大小</p>
<p>sismember key element  是否存在</p>
<p>srandmember  随机</p>
<p>smembers 所有</p>
<p>spop </p>
<p>抽奖系统 &#x2F;tag标签 </p>
<p>sdiff key1 key2  差集</p>
<p>sinter  key1 key2 交集</p>
<p>sunion   key1 key2 并集</p>
<p>共同关注好友、喜欢</p>
<p>SADD &#x3D; Tagging<br>SPOP&#x2F;SRANDMEMBER &#x3D; Random item<br>SADD + SINTER &#x3D; Social Graph</p>
<h2 id="zset"><a href="#zset" class="headerlink" title="zset"></a>zset</h2><p>有序集合</p>
<table>
<thead>
<tr>
<th>key</th>
<th>score</th>
<th>val</th>
</tr>
</thead>
<tbody><tr>
<td>user:ranking</td>
<td>1</td>
<td>lisi</td>
</tr>
<tr>
<td></td>
<td>44</td>
<td>wuli</td>
</tr>
<tr>
<td></td>
<td>50</td>
<td>sss</td>
</tr>
</tbody></table>
<p>zadd  key score element  (nlogn)</p>
<p>zrem key element  …</p>
<p>zscore key element  </p>
<p>zincrby key increscore element  增分</p>
<p>zcard key 个数</p>
<p>zrange key start end [withscore]</p>
<p>zrangebyscore key minScore maxScore[WITHSCORES]<br>#返回指定分数范围内的升序元素[分值]</p>
<p>zcount key minScore maxScore<br>#返回有序集合内在指定分数范围内的个数</p>
<p>zremrangebyrank key start end</p>
<p>#删除指定排名内的升序元素</p>
<p>zremrangebyscore key minScore maxScore</p>
<p>#删除指定分数内的升序元素</p>
<p>zrevrank<br>zrevrange<br>zrevrangebyscore<br>zinterstore<br>zunionstore</p>
<p>排行榜单 score: timeStamp、 saleCount、 followCount</p>
<h2 id="Jedis-x2F-Jedispool"><a href="#Jedis-x2F-Jedispool" class="headerlink" title="Jedis&#x2F;Jedispool"></a>Jedis&#x2F;Jedispool</h2><p>redis连接工具</p>
<p>maxTotal<br>资源池最大连接数<br>maxIdle<br>资源池允许最大空闲连接数<br>minIdle<br>资源池确保最少空闲连接数<br>jmxEnabled<br>是否开启jmx监控，可用于监控</p>
<p>blockWhenEx当资源池用尽后，调用者是否要等truehausted<br>待。只有当为true时，下面的maxWaitMillis才会生效</p>
<p>maxWaitMillis当资源池连接用尽后，调用者的最大等待时间(单位为毫秒)<br>-1:表示永不超时</p>
<p>testOnBorrow<br>向资源池借用连接时是否做连接有 效性检测(ping)，无效连接会被移除</p>
<p>testOnReturn</p>
<p>向资源池归还连接时是否做连接有效性检测(ping)，无效连接会被移除</p>
<p>比较难确定的，举个例子∶<br>1.命令平均执行时间0.1ms &#x3D; 0.001s。</p>
<p>2.业务需要50000 QPS。</p>
<p>3.maxTotal理论值&#x3D; 0.001* 50000 &#x3D; 50个。实际值要偏大一些。</p>
<p>建议maxIdle &#x3D; maxTotal (减少创建新连接的开销。)</p>
<p>建议预热minIdle ( 减少第一次启动后的新连接开销。)</p>
<p>​    </p>
<p><img src="/upload/pics/p3.png"></p>
<p>解决方案<br>1.慢查询阻塞:池子连接都被hang住。<br>2.资源池参数不合理∶例如QPS高、池子小。<br>3.连接泄露(没有close()):此类问题比较难定位，例如client list、netstat等，最重要的是代码。</p>
<h2 id="慢查询"><a href="#慢查询" class="headerlink" title="慢查询"></a>慢查询</h2><p>1.client发生命令</p>
<p>2.redis 命令排队（队列）</p>
<p>3.执行命令</p>
<p>4.返回结果给client</p>
<p>说明：</p>
<p>(1)慢查询发生在第3阶段</p>
<p>(2)客户端超时不一定慢查询，但慢查询是客户端超时的一个可能因素</p>
<p>配置：</p>
<p>slowlog-max-len 队列最大长度  默认128</p>
<p>slowlog-log-slower-than  默认10000</p>
<p>   1.慢查询阈值(单位:微秒)</p>
<ol start="2">
<li>slowlog-log-slower-than&#x3D;0，记录所有命令</li>
<li>slowlog-log-slower-than&lt;0，不记录任何命令。</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">config set slowlog-max-len 1000</span><br><span class="line">config set slowlog-log-slower-than 1000</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>slowlog get [n]:获取慢查询队列</p>
<p>slowlog len:获取慢查询队列长度</p>
<p>slowlog reset:清空慢查询队列</p>
<p>slowlog-log-slower-than不要设置过大，默认10ms，通常设置1ms</p>
<p>slowlog-max-len不要设置过小，通常设置1000左右。</p>
<h2 id="pipeline"><a href="#pipeline" class="headerlink" title="pipeline"></a>pipeline</h2><p>1次pipeline(n条命令)&#x3D;1次网络时间+n次命令时间</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>N个命令</th>
<th>1次1次pipeline(n条命令)</th>
</tr>
</thead>
<tbody><tr>
<td>时间</td>
<td>n次网络时间+n次命令时间</td>
<td>1次网络时间+n次命令时间</td>
</tr>
<tr>
<td>数据量</td>
<td>1条命令</td>
<td>n条命令</td>
</tr>
</tbody></table>
<p>1.Redis的命令时间是微秒级别。</p>
<ol start="2">
<li>pipeline每次条数要控制(网络)。</li>
</ol>
<p>注意每次pipeline携带数据量</p>
<p>pipeline每次只能作用在一个Redis节点上</p>
<p>M操作与pipeline区别</p>
<h2 id="发布订阅"><a href="#发布订阅" class="headerlink" title="发布订阅"></a>发布订阅</h2><p>publish channel msg</p>
<p>subscribe [channel]  # ─个或多个</p>
<p>unsubscribe [channel]  # ─个或多个</p>
<p>psubscribe [pattern…]#订阅模式。<br>punsubscribe [pattern…]#退订指定的模式。<br>pubsub channels #列出至少有一个订阅者的频道。<br>pubsub numsub [channel…] #列出给定频道的订阅者数量</p>
<h2 id="Bitmap"><a href="#Bitmap" class="headerlink" title="Bitmap"></a>Bitmap</h2><p>setbit key offset val</p>
<p>getbit key offset </p>
<p>bitcount key [start end]<br>获取位图指定范围(start到end，单位为字节，如果不指定就是获取全部)位值为1的个数</p>
<p>bitop op destkey key [key…]<br>做多个Bitmap的and(交集)、or(并集)、not(非)、xor(异或)操作并将结果保存在destkey中</p>
<p>bitpos key targetBit [start] [end]<br>计算位图指定范围(start到end，单位为字节，如果不指定就是获取全部)第一个偏移量对应的值等于targetBit的位置</p>
<p>用户在线人数统计等。</p>
<h2 id="hyperloglog"><a href="#hyperloglog" class="headerlink" title="hyperloglog"></a>hyperloglog</h2><p>pfadd key element [element …]:向hyperloglog添加元素<br>pfcount key [key …]:计算hyperloglog的独立总数<br>pfmerge destkey sourcekey [sourcekey …]:合并多个hyperloglog</p>
<h2 id="geo"><a href="#geo" class="headerlink" title="geo"></a>geo</h2><p>redis 3.2+</p>
<p>geo key longitude latitude member[longitude latitude member …]<br>#增加地理位置信息</p>
<p>如：geoadd cities:locations 116.28 39.55 beijing</p>
<p>geopos key member [member …]#获取地理位置信息</p>
<p>geodist key member1 member2 [unit]</p>
<p>#获取两个地理位置的距离<br>#unit: m(米)、km(千米)、mi(英里)、ft(尺)</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">georadius key longitude latitude radiusm|kmlft|mi [withcoord] [withdist][withhash] [COUNT count] [asc|desc][store key][storedist key]</span><br><span class="line"></span><br><span class="line">georadiusbymember key member radiusm|km|ft|mi [withcoord][withdist] [withhash] [COUNT count] [asc|desc] [store key][storedist key]<span class="comment">#获取指定位置范围内的地理位置信息集合</span></span><br><span class="line"></span><br><span class="line">withcoord :返回结果中包含经纬度。</span><br><span class="line">withdist :返回结果中包含距离中心节点位置。withhash :返回结果中包含geohash</span><br><span class="line">COUNT count:指定返回结果的数量。</span><br><span class="line">ascldesc :返回结果按照距离中心节点的距离做升序或者降序。store key :将返回结果的地理位置信息保存到指定键。</span><br><span class="line">storedist key :将返回结果距离中心节点的距离保存到指定键</span><br><span class="line"></span><br><span class="line">如：距离北京150km</span><br><span class="line">georadiusbymember cities:locations beijing 150 km</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h2><p>RDB：</p>
<p>1.命令方式</p>
<p>save （同步）（O（n))  会阻塞客户端命令</p>
<p>bgsave（异步） fork函数 由子进程生成RDB文件   需要fork,消耗内存</p>
<p>2.配置文件redis.conf</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">save 900 1</span><br><span class="line"></span><br><span class="line">save 300 10</span><br><span class="line"></span><br><span class="line">save 60 10000</span><br><span class="line"></span><br><span class="line">dbfilename dump.rdb</span><br><span class="line"></span><br><span class="line">dir ./</span><br><span class="line"></span><br><span class="line">stop-writes-on-bgsave-error yes         错误停止写入</span><br><span class="line"></span><br><span class="line"> yesrdbcompression yes       压缩</span><br><span class="line"></span><br><span class="line">rdbchecksum yes           校验和</span><br></pre></td></tr></table></figure>

<p>触发机制-不容忽略方式<br>  1.全量复制</p>
<ol start="2">
<li>debug reload</li>
<li>shutdown</li>
</ol>
<p>RDB是Redis内存到硬盘的快照，用于持久化。</p>
<p>save通常会阻塞Redis。<br>bgsave不会阻塞Redis，但是会fork新进程。</p>
<p>save自动配置满足任一就会被执行。</p>
<p>有些触发机制不容忽视</p>
<p>AOF:</p>
<p>always  不丢失数据，IO开销大</p>
<p>everysec  每秒一闪fsync ，丢1秒数据</p>
<p>no  不可控</p>
<p>AOF重写：命令优化，删除重复，过期数据优化</p>
<p>1.bgrewriteaof    fork子进程 内存中 AOF重写</p>
<p>2.配置方式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">auto-aof-rewrite-min-size</span><br><span class="line">AOF文件重写需要的尺寸</span><br><span class="line">auto-aof-rewrite-percentage</span><br><span class="line">AOF文件增长率</span><br><span class="line"></span><br><span class="line">aof_current_size</span><br><span class="line">AOF当前尺寸(单位:字节)</span><br><span class="line">aof_base_size</span><br><span class="line">AOF上次启动和重写的尺寸(单位:字节)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">自动触发时机</span><br><span class="line">aof_current_size &gt; auto-aof-rewrite-min-size</span><br><span class="line">aof_current_size - aof_base_size/aof_base_size &gt; auto-aof-rewrite-percentage</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/upload/pics/p4.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> appendonly yes</span><br><span class="line"> </span><br><span class="line"> appendonly yes</span><br><span class="line">appendfilename &quot;appendonly-$&#123;port&#125;.aof&quot;</span><br><span class="line">appendfsync everysec</span><br><span class="line">dir /bigdiskpath</span><br><span class="line">no-appendfsync-on-rewrite yes </span><br><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br><span class="line"></span><br><span class="line">aof-load-truncated yes </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>命</th>
<th>RDB</th>
<th>AOF</th>
</tr>
</thead>
<tbody><tr>
<td>启动优先级</td>
<td>低</td>
<td>高</td>
</tr>
<tr>
<td>体积</td>
<td>小</td>
<td>大</td>
</tr>
<tr>
<td>恢复</td>
<td>快</td>
<td>慢</td>
</tr>
<tr>
<td>轻重</td>
<td>重</td>
<td>轻</td>
</tr>
</tbody></table>
<h2 id="fork-操作"><a href="#fork-操作" class="headerlink" title="fork 操作"></a>fork 操作</h2><p>改善fork<br>优先使用物理机或者高效支持fork操作的虚拟化技术</p>
<p>控制Redis实例最大可用内存: maxmemory</p>
<p>合理配置Linux内存分配策略: vm.overcommit_memory&#x3D;1</p>
<p>降低fork频率∶例如放宽AOF重写自动触发时机，不必要的全量复制</p>
<p><img src="/upload/pics/p5.png"></p>
<h2 id="主从复制"><a href="#主从复制" class="headerlink" title="主从复制"></a>主从复制</h2><p>一主一从</p>
<p>一主多从</p>
<p>1.一个master可以有多个slave<br>2.一个slave只能有一个master<br>3.数据流向是单向的，master到slave</p>
<p>slaveof  主ip</p>
<p>slaveof no one 取消</p>
<p>配置方式</p>
<p>slaveof ip port<br>slave-read-only yes</p>
<p>全量复制开销</p>
<ol>
<li>bgsave时间<br>2.RDB文件网络传输时间3.从节点清空数据时间<br>4.从节点加载RDB的时间<br>5.可能的AOF重写时间</li>
</ol>
<p><img src="/upload/pics/p6.png"></p>
<p>Master挂掉 ：【手动故障转移】选slave作为master</p>
<p>读写分离<br>1.读写分离:读流量分摊到从节点。<br>2.可能遇到问题:<br>·复制数据延迟<br>·读到过期数据<br>·从节点故障</p>
<p>配置不一致<br>例如maxmemory不一致:丢失数据</p>
<p>规避全量复制<br>1.第一次全量复制<br>·第一次不可避免·小主节点、低峰</p>
<p>2.节点运行ID不匹配。</p>
<p>主节点重启</p>
<p>(运行ID变化)·故障转移，例如哨兵或集群</p>
<p>3．复制积压缓冲区不足。</p>
<p>网络中断，部分复制无法满足<br>。增大复制缓冲区配置rel_backlog_size，网络“增强”。</p>
<p>1.单主节点复制风暴︰<br>问题:主节点重启，多从节点复制解决︰更换复制拓扑<br>2.单机器复制风暴<br>如右图∶机器宕机后，大量全量复制主节点分散多机器</p>
<h2 id="redis-sentinel"><a href="#redis-sentinel" class="headerlink" title="redis sentinel"></a>redis sentinel</h2><p>默认端口 26379</p>
<p><img src="/upload/pics/p7.png"></p>
<p>故障转移：</p>
<p>1.多个sentinel发现并确认master有问题。</p>
<p>⒉选举出一个sentinel作为领导。<br>3.选出一个slave作为master。<br>4.通知其余slave成为新的master的slave。</p>
<p>5.通知客户端主从变化<br>6.等待老的master复活成为新master的slave。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#sentinel配置</span></span><br><span class="line">port <span class="variable">$&#123;port&#125;</span></span><br><span class="line"><span class="built_in">dir</span> <span class="string">&quot;/opt/soft/redis/data/&quot;</span>logfile<span class="string">&quot;<span class="variable">$&#123;port&#125;</span>.log&quot;</span></span><br><span class="line">sentinel monitor mymaster 127.0.0.1 7000 2  <span class="comment">#2 表2个sentinel认为master有问题，才故障转移</span></span><br><span class="line">sentinel down-after-milliseconds mymaster 30000 <span class="comment">#毫秒</span></span><br><span class="line">sentinel parallel-syncs mymaster 1 </span><br><span class="line">sentinel failover-timeout mymaster 180000 </span><br><span class="line"></span><br><span class="line"><span class="comment">#启动命令</span></span><br><span class="line">dis-sentinel redis-sent-26379.conf</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p> 客户端接入流程<br>1.Sentinel地址集合</p>
<ol start="2">
<li><p>masterName</p>
</li>
<li><p>不是代理模式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">JedisSentinelPool sentinelPool = new JedisSentinelPool(masterName, sentinelSet, poolConfig, timeout);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>三个定时任务<br>1.每10秒每个sentinel对master和slave执行info<br>发现slave节点<br>确认主从关系<br>2.每2秒每个sentinel通过master节点的channel交换信息(pub&#x2F;sub)·</p>
<p>通过_sentinel_:hello频道交互<br>。交互对节点的“看法”和自身信息<br>3.每1秒每个sentinel对其他sentinel和redis执行ping</p>
<p>·心跳检测，失败判定依据</p>
</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sentinel monitor &lt;masterName&gt; &lt;ip&gt;&lt;port&gt; &lt;quorum&gt;</span><br><span class="line">sentinel monitor myMaster 127.0.0.1 6379 2</span><br><span class="line">sentinel down-after-milliseconds &lt;masterName&gt; &lt;<span class="built_in">timeout</span>&gt;</span><br><span class="line">sentinel down-after-milliseconds mymaster 30000</span><br><span class="line"></span><br><span class="line"><span class="comment">#主观下线:每个sentinel节点对Redis节点失败的&#x27;偏见”</span></span><br><span class="line"><span class="comment">#客观下线:所有sentinel节点对Redis节点失败“达成共识”（超过quorum个统一)</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>领导者选举<br>原因:只有一个sentinel节点完成故障转移</p>
<p>选举:通过sentinel is-master-down-by-addr命令都希望成为领导者<br>·<br>1.每个做主观下线的Sentinel节点向其他Sentinel节点发送命令，要求将它设置为领导者。</p>
<ol start="2">
<li><p>收到命令的Sentinel节点如果没有同意通过其他Sentinel节点发送的命令，那么将同意该请求，否则拒绝</p>
</li>
<li><p>如果该Sentinel节点发现自己的票数已经超过Sentinel集合半数且超过quorum，那么它将成为领导者。</p>
</li>
</ol>
<p>4.如果此过程有多个Sentinel节点成为了领导者，那么将等待一段时间重新进行选举。</p>
<p>故障转移( sentinel领导者节点完成)<br>1.从slave节点中选出一个“合适的”节点作为新的master节点<br>2.对上面的slave节点执行slaveof no one命令让其成为master节点。<br>3.向剩余的slave节点发送命令，让它们成为新master节点的slave节点，复制规则和parallel-syncs参数有关。<br>4.更新对原来master节点配置为slave，并保持着对其“关注“，当其恢复后命令它去复制新的master节点。</p>
<p>选择“合适的”slave节点<br>1选择slave-priority(slave节点优先级)最高的slave节点，如果存在则返回，不存在则继续。<br>2选择复制偏移量最大的slave节点(复制的最完整)，如果存在则返回，不存在则继续。<br>3选择runId最小的slave节点。</p>
<h2 id="redis-cluster"><a href="#redis-cluster" class="headerlink" title="redis cluster"></a>redis cluster</h2><p>节点取余<br>客户端分片∶哈希＋取余<br>节点伸缩︰数据节点关系变化，导致数据迁移<br>迁移数量和添加节点数量有关∶建议翻倍扩容</p>
<p>一致性哈希<br>客户端分片∶哈希＋顺时针（优化取余)<br>节点伸缩∶只影响邻近节点，但是还是有数据迁移<br>翻倍伸缩∶保证最小迁移数据和负载均衡</p>
<p>虚拟槽分区<br>预设虚拟槽:每个槽映射一个数据子集，一般比节点数大<br>良好的哈希函数∶例如CRC16<br>服务端管理节点、槽、数据︰例如Redis Cluster</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置开启Redis</span></span><br><span class="line">port <span class="variable">$&#123;port&#125;</span></span><br><span class="line">daemonize <span class="built_in">yes</span></span><br><span class="line"><span class="built_in">dir</span> <span class="string">&quot;lopt/redis/redis/data/&quot;</span></span><br><span class="line">dbfilename <span class="string">&quot;dump-<span class="variable">$&#123;port&#125;</span>.rdb&quot;</span></span><br><span class="line">logfile <span class="string">&quot;<span class="variable">$&#123;port&#125;</span>.log&quot;</span></span><br><span class="line">cluster-enabled <span class="built_in">yes</span></span><br><span class="line">cluster-config-file nodes-<span class="variable">$&#123;port&#125;</span>.conf</span><br><span class="line"></span><br><span class="line"><span class="comment">#meet</span></span><br><span class="line">cluster meet ip port</span><br><span class="line"></span><br><span class="line">redis-cli -h 127.0.0.1 -p 7000 cluster meet 127.0.0.1 7001</span><br><span class="line">redis-cli -h 127.0.0.1 -p 7000 cluster meet 127.0.0.1 7002</span><br><span class="line">redis-cli -h 127.0.0.1 -p 7000 cluster meet 127.0.0.1 7003</span><br><span class="line">redis-cli -h 127.0.0.1-p 7000 cluster meet 127.0.0.1 7004</span><br><span class="line">redis-cli -h 127.0.0.1-p 7000 cluster meet 127.0.0.1 7005</span><br><span class="line"></span><br><span class="line"><span class="comment">#Cluster节点主要配置</span></span><br><span class="line">cluster-enabled <span class="built_in">yes</span></span><br><span class="line">cluster-node-timeout 15000</span><br><span class="line">cluster-config-file <span class="string">&quot;nodes.conf&quot;</span></span><br><span class="line">cluster-require-full-coverage no</span><br><span class="line"></span><br><span class="line"><span class="comment">#分配槽</span></span><br><span class="line">cluster addslots slot [slot ...]</span><br><span class="line">redis-cli -h 127.0.0.1 -p 7000 cluster addslots &#123;0..5461&#125;</span><br><span class="line">redis-cli -h 127.0.0.1 -p 7001 cluster addslots &#123;5462...10922&#125;</span><br><span class="line">redis-cli -h 127.0.0.1 -p 7002 cluster addslots &#123;10923...16383&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#设置主从</span></span><br><span class="line">cluster replicate node-id</span><br><span class="line">redis-cli -h 127.0.0.1 -p 7003</span><br><span class="line">cluster replicate <span class="variable">$&#123;node-id-7000&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>moved和ask<br>两者都是客户单重定向<br>moved:槽已经确定迁移<br>ask:槽还在迁移中</p>
<h2 id="jediscluster"><a href="#jediscluster" class="headerlink" title="jediscluster"></a>jediscluster</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//JedisCluster基本使用</span></span><br><span class="line">Set&lt;HostAndPort&gt; nodeList = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;HostAndPort&gt;();</span><br><span class="line">nodeList.add(<span class="keyword">new</span> <span class="title class_">HostAndPort</span>(HOST1, PORT1));</span><br><span class="line">nodeList.add(<span class="keyword">new</span> <span class="title class_">HostAndPort</span>(HOST2,PORT2));</span><br><span class="line">nodeList.add(<span class="keyword">new</span> <span class="title class_">HostAndPort</span>(HOST3, PORT3));</span><br><span class="line">nodeList.add(<span class="keyword">new</span> <span class="title class_">HostAndPort</span>(HOST4, PORT4));</span><br><span class="line">nodeList.add(<span class="keyword">new</span> <span class="title class_">HostAndPort</span>(HOST5, PORT5));</span><br><span class="line">nodeList.add(<span class="keyword">new</span> <span class="title class_">HostAndPort</span>(HOST6, PORT6));</span><br><span class="line"><span class="type">JedisCluster</span> <span class="variable">redisCluster</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JedisCluster</span>(nodeList, timeout, poolConfig<span class="comment">////);</span></span><br><span class="line">redisCluster.command...</span><br><span class="line"></span><br><span class="line">                           <span class="comment">// 多节点命令实现                  </span></span><br><span class="line">                                            </span><br><span class="line"><span class="comment">//获取所有节点的JeidsPool</span></span><br><span class="line">Map&lt;String, JedisPool&gt; jedisPoolMap = jedisCluster.getClusterNodes();</span><br><span class="line">   <span class="keyword">for</span> (Entry&lt;String, JedisPool&gt; entry : jedisPoolMap.entrySet())&#123;</span><br><span class="line"><span class="comment">//获取每个节点的Jedis连接</span></span><br><span class="line">       <span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> entry.getValue().getResource();/只删除主节点数据</span><br><span class="line">        <span class="keyword">if</span> (!isMaster(jedis)) &#123;<span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">   &#125;</span><br><span class="line">                                             </span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>集群完整性:</p>
<p>cluster-require-full-coverage默认为yes<br>集群中16384个槽全部可用∶保证集群完整性<br>节点故障或者正在故障转移︰<br>(error) CLUSTERDOWN The cluster is down<br>大多数业务无法容忍，cluster-require-full-coverage建议设置为no</p>
<p>数据倾斜<br>节点和槽分配不均<br>不同槽对应键值数量差异较大<br>包含bigkey<br>内存相关配置不一致</p>
<p>请求倾斜<br>热点key:重要的key或者bigkey优化:<br>-避免bigkey<br>-热键不要用hash_tag<br>-当一致性不高时，可以用本地缓存＋MQ</p>
<p>集群读写分离<br>只读连接︰集群模式的从节点不接受任何读写请求。<br>-重定向到负责槽的主节点</p>
<p>-readonly命令可以读:连接级别命令</p>
<p>离线&#x2F;在线迁移<br>官方迁移工具:redis-trib.rb import</p>
<p>-只能从单机迁移到集群<br>-不支持在线迁移: source需要停写-不支持断点续传<br>-单线程迁移∶影响速度<br>在线迁移∶<br>-唯品会redis-migrate-tool</p>
<p>-豌豆荚:redis-port</p>
<p>思考-分布式Redis不一定好<br>.<br>1.Redis Cluster:满足容量和性能的扩展性，很多业务”不需要<br>大多数时客户端性能会”降低”。<br>命令无法跨节点使用: mget、keys、scan、flush、sinter等。</p>
<p>Lua和事务无法跨节点使用。<br>客户端维护更复杂:SDK和应用本身消耗(例如更多的连接池)。</p>
<p>2.很多场景Redis Sentinel已经足够好。</p>
<h1 id="缓存使用和优化"><a href="#缓存使用和优化" class="headerlink" title="缓存使用和优化"></a>缓存使用和优化</h1><p>缓存更新策略<br>1.LRU&#x2F;LFU&#x2F;FIFO算法剔除︰例如maxmemory-policy。<br>2.超时剔除∶例如expire。<br>3.主动更新:开发控制生命周期</p>
<p>两条建议<br>1.低一致性:最大内存和淘汰策略<br>2.高一致性:超时剔除和主动更新结合，最大内存和淘汰策略兜底。</p>
<p>缓存粒度控制-三个角度<br>1.通用性:全量属性更好。<br>2.占用空间︰部分属性更好。<br>3．代码维护:表面上全量属性更好。</p>
<h2 id="缓存穿透"><a href="#缓存穿透" class="headerlink" title="缓存穿透"></a>缓存穿透</h2><p>原因<br>1.业务代码自身问题<br>2.恶意攻击、爬虫等等</p>
<p>如何发现<br>1.业务的相应时间<br>2.业务本身问题<br>3.相关指标∶总调用数、缓存层命中数、存储层命中数</p>
<p>解决方案：</p>
<p>1.缓存空对象，并设置过期时间</p>
<p>两个问题<br>i.需要更多的键。<br>ii.缓存层和存储层数据“短期”不一致。</p>
<p>2.布隆过滤器拦截</p>
<p>问题<br>现有50亿个电话号码，现有10万个电话号码，要快速准确判断这些电话号码是否已经存在?<br>.通过数据库查询:实现快速有点难。<br>.数据预放在集合中:50亿*8字节～ 40GB(内存浪费或不够)</p>
<p>类似问题很多<br> 垃圾邮件过滤<br> 文字处理软件（例如word )错误单词检测<br> 网络爬虫重复url检测。</p>
<p>布隆过滤器构建<br>参数:m个二进制向量，n个预备数据，k个hash函数<br>构建布隆过滤器:n个预备数据走一遍上面过程<br>判断元素存在∶走一遍上面过程∶如果都是1，则在表明存在，反之不存在。</p>
<p>误差率<br>·肯定存在误差︰恰好都命中了。<br>·直观因素:m&#x2F;n的比率，hash函数的个数。</p>
<p>m&#x2F;n与误差率成反比，k与误差率成反比。</p>
<p>本地布隆过滤器<br>·现有库:guava<br>·本地布隆过滤器的问题︰<br>(1)容量受限制。<br>(2)多个应用存在多个布隆过滤器，构建同步复杂。</p>
<p>基于Redis单机实现存在的问题<br>速度慢︰比本地慢，输在网络<br>-解决:单独部署，与应用同机房甚至机架部署。<br>容量受限:Redis最大字符串为512MB、Redis单机容量。<br>-解决︰基于Redis Cluster实现。</p>
<h2 id="雪崩"><a href="#雪崩" class="headerlink" title="雪崩"></a>雪崩</h2><p>雪崩问题︰缓存层高可用、客户端降级、提前演练是解决雪崩问题的重要方法。</p>
<h2 id="无底洞"><a href="#无底洞" class="headerlink" title="无底洞"></a>无底洞</h2><p>优化IO的几种方法<br>1.命令本身优化∶例如慢查询keys、hgetall bigkey<br>2.减少网络通信次数<br>3．降低接入成本︰例如客户端长连接&#x2F;连接池、NIO等</p>
<h2 id="热点key重新问题"><a href="#热点key重新问题" class="headerlink" title="热点key重新问题"></a>热点key重新问题</h2><p>产生原因：多个线程对key访问，前面的线程并没有完全建立缓存，后面线程再次建立缓存。</p>
<p>三个目标和两个解决<br>1.三个目标︰<br>减少重缓存的次数</p>
<p>数据尽可能一致</p>
<p>减少潜在危险</p>
<p>2.两个解决︰<br>·互斥锁(mutex key)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//伪代码</span></span><br><span class="line">String <span class="title function_">get</span><span class="params">(String key)</span>&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span>redis.get(key);</span><br><span class="line">    <span class="keyword">if</span> (value == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">mutexKey</span> <span class="operator">=</span> <span class="string">&quot;mutex:key:&quot;</span> + key;</span><br><span class="line">        <span class="keyword">if</span> (redis.set(mutexKey, <span class="string">&quot;1&quot;</span>,<span class="string">&quot;ex 180&quot;</span>, <span class="string">&quot;nx&quot;</span>))&#123;</span><br><span class="line">        value = db.get(key);</span><br><span class="line">        redis.set(key, value);</span><br><span class="line">        redis.delete(mutexKey);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//其他线程休息50毫秒后重试Thread.sleep(50);</span></span><br><span class="line">            get(key);</span><br><span class="line">         &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>·永远不过期</p>
<p>存在问题：不保证一致性</p>
<p>1.缓存层面∶没有设置过期时间(没有用expire)。<br>2．功能层面:为每个value添加逻辑过期时间，但发现超过逻辑过期时间后，会使用单独的线程去构建、缓存。</p>
<h1 id="设计规范"><a href="#设计规范" class="headerlink" title="设计规范"></a>设计规范</h1><h2 id="Key名设计"><a href="#Key名设计" class="headerlink" title="Key名设计"></a>Key名设计</h2><p>三大建议</p>
<h2 id="1-可读性和可管理性"><a href="#1-可读性和可管理性" class="headerlink" title="1 可读性和可管理性"></a>1 可读性和可管理性</h2><p>以业务名（或数据库名）为前缀（防止key冲突），用冒号分割，比如业务名:表名:id，如: ugc:video:1</p>
<h2 id="2简洁性"><a href="#2简洁性" class="headerlink" title="2简洁性"></a>2简洁性</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">保证语义的前提下，控制key的长度，当key较多时，内存占用也不容忽视( redis3:39字节embstr)，如:user:&#123;uid &#125;:friends:messages:&#123;mid&#125;简化为u:&#123;uid&#125;: fr:m:&#123;mid&#125;</span><br></pre></td></tr></table></figure>



<h2 id="3不要包含特殊字符"><a href="#3不要包含特殊字符" class="headerlink" title="3不要包含特殊字符"></a>3不要包含特殊字符</h2><p>反例:包含空格、换行、单双引号以及其他转义字符</p>
<h2 id="Value设计"><a href="#Value设计" class="headerlink" title="Value设计"></a>Value设计</h2><h3 id="1拒绝bigkey"><a href="#1拒绝bigkey" class="headerlink" title="1拒绝bigkey"></a>1拒绝bigkey</h3><p>强制<br>string类型控制在10KB以内<br>hash、list、set、zset元素个数不要超过5000</p>
<p>反例:一个包含几百万个元素的list、hash等，一个巨大的json字符串</p>
<p>bigkey的危害:</p>
<p>网络阻塞<br>集群节点数据不均衡<br>Redis阻塞<br>频繁序列化∶应用服务器CPU消耗</p>
<p>bigkey发现:<br>◆应用异常<br>redis-cli –bigkeys<br>scan + debug object<br>主动报警∶网络流量监控、客户端监控<br>内核热点key问题优化</p>
<h3 id="2选择合适的数据结构"><a href="#2选择合适的数据结构" class="headerlink" title="2选择合适的数据结构"></a>2选择合适的数据结构</h3><p>例如:实体类型（数据结构内存优化:例如ziplist，注意内存和性能的平衡)</p>
<p>反例:<br>set user:1:name tom;<br>set user:1:age 19;<br>set user:1:favor football</p>
<p>正例:<br>hmset user:1 name tom age 19 favor football</p>
<h3 id="3过期设计"><a href="#3过期设计" class="headerlink" title="3过期设计"></a>3过期设计</h3><p>周期数据需要设置过期时间，object idle time可以找垃圾key-value<br>过期时间不宜集中∶缓存穿透和雪崩等问题</p>
<p>1.惰性删除∶访问key -&gt; expired dict -&gt; del key</p>
<p>2.定时删除︰每秒运行10次，采样删除。</p>
<p>超过maxmemory后触发相应策略，由maxmemory-policy控制。<br>Noeviction:默认策略，不会删除任何数据，拒绝所有写入操作并返回端错误信息“ ( error ) OOM command not allowed when usedmemory”此时Redis只响应读操作由maxmemory-policy控制。</p>
<p>Volatile-Iru:根据LRU算法删除设置了超时属性（ expire )的键，直到腾出足够空间为止。如果没有可删除的键对象，回退到noeviction策略。</p>
<p>Allkeys-lru:根据LRU算法删除键，不管数据有没有设置超时属性，直到腾出足够空间为止。</p>
<p>Allkeys-random:随机删除所有键，直到腾出足够空间为止。<br>volatile-random :随机删除过期键，直到腾出足够空间为止。<br>volatile-ttl:根据键值对象的ttl属性，删除最近将要过期数据。如果没有，回退到noeviction策略。</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">夜雨</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://blog.yeyusmile.top/2022/03/17/redis/">https://blog.yeyusmile.top/2022/03/17/redis/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.yeyusmile.top">夜雨小屋</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/redis/">redis</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2022/07/12/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E6%A6%82%E8%BF%B0/"><i class="fa fa-chevron-left">  </i><span>垃圾回收概述</span></a></div><div class="next-post pull-right"><a href="/2022/01/20/vue%E5%85%A5%E9%97%A8/"><span>vue入门</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="disqus_thread"></div><script>var unused = null;
var disqus_config = function () {
  this.page.url = 'https://blog.yeyusmile.top/2022/03/17/redis/';
  this.page.identifier = '2022/03/17/redis/';
  this.page.title = '缓存数据库redis';
}
var d = document, s = d.createElement('script');
s.src = "https://" + 'mryang' +".disqus.com/embed.js";
s.setAttribute('data-timestamp', '' + +new Date());
(d.head || d.body).appendChild(s);</script><script id="dsq-count-scr" src="https://mryang.disqus.com/count.js" async></script></div></div><footer class="footer-bg" style="background-image: url(https://s1.ax1x.com/2023/01/10/pSmKTYT.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2020 - 2023 By 夜雨</div><div class="framework-info"><span>驱动 - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">hitokoto</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/lib/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.1"></script><script src="/js/fancybox.js?version=1.9.1"></script><script src="/js/sidebar.js?version=1.9.1"></script><script src="/js/copy.js?version=1.9.1"></script><script src="/js/fireworks.js?version=1.9.1"></script><script src="/js/transition.js?version=1.9.1"></script><script src="/js/scroll.js?version=1.9.1"></script><script src="/js/head.js?version=1.9.1"></script><script src="/js/search/local-search.js"></script><script id="ribbon" src="/js/third-party/canvas-ribbon.js" size="150" alpha="0.6" zIndex="-1" data-click="true"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>