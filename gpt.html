<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AI Chat</title>
  <meta name="viewport"
  	content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.1.0/github-markdown.css" media="(prefers-color-scheme: light)">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css">
  
  
  
  <style>
    body {
      background-color: #f7f9ff;
      font-family: Arial, sans-serif;
    }
	
	.modal {
	  display: none;
	  position: fixed;
	  z-index: 1;
	  left: 0;
	  top: 0;
	  width: 100%;
	  height: 100%;
	  overflow: auto;
	  background-color: rgba(0, 0, 0, 0.4);
	}
	
	.modal-content {
	  background-color: gray;
	  margin: 15% auto;
	  padding: 20px;
	  border: 1px solid #888;
	  width: 30%;
	  text-align: center;
	  position: relative;
	}
	
	.spinner {
	  border: 4px solid rgba(0, 0, 0, 0.1);
	  border-top-color: #7983ff;
	  border-radius: 50%;
	  width: 20px;
	  height: 20px;
	  animation: spin 1s linear infinite;
	  margin: 0 auto 10px auto;
	}
	
	@keyframes spin {
	  to {
	    transform: rotate(360deg);
	  }
	}
    
    #chat-container {
      width: 80%; /* 在移动设备上，聊天框应该填满屏幕 */
      margin: 50px auto;
      background-color: #ffffff;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    
    #chat-header {
      padding: 20px;
      text-align: center;
      font-size: 24px;
      font-weight: bold;
      border-bottom: 1px solid #e6e6e6;
    }
    
    #chat-messages {
      height: 300px;
      overflow-y: scroll;
      padding: 20px;
    }
	
	#chat-messages::-webkit-scrollbar {
	  width: 8px;
	}
	
	#chat-messages::-webkit-scrollbar-track {
	  background-color: #f1f1f1;
	}
	
	#chat-messages::-webkit-scrollbar-thumb {
	  background-color: #888;
	  border-radius: 5px;
	}
	
	#chat-messages::-webkit-scrollbar-thumb:hover {
	  background-color: #555;
	}
	
	textarea::-webkit-scrollbar {
	  width: 8px;
	}
	
	textarea::-webkit-scrollbar-track {
	  background-color: #f1f1f1;
	}
	
	textarea::-webkit-scrollbar-thumb {
	  background-color: #888;
	  border-radius: 5px;
	}
	
	textarea::-webkit-scrollbar-thumb:hover {
	  background-color: #555;
	}
    
    .message {
      margin-bottom: 20px;
    }
    
    .message.from-user {
      text-align: right;
    }
    
    .message.from-bot {
      text-align: left;
    }
    
    .message-content {
      display: inline-block;
      max-width: 80%;
      padding: 10px;
      border-radius: 5px;
      color: #ffffff;
      font-size: 14px;
      line-height: 1.5;
    }
    
    .from-user .message-content {
      background-color: #283f57;
    }
    
    .from-bot .message-content {
      background-color: #1a1a1a;
    }
	
	
	.message-avatar {
	  display: inline-block;
	  width: 40px;
	  height: 40px;
	  border-radius: 50%;
	  margin-right: 10px;
	  background-size: cover;
	}
	
	.from-user .message-avatar {
	
	  background-image: url("./user.jpg");
	}
	
	.from-bot .message-avatar {
	  background-image: url("./bot.jpg");
	}
	
	.from-user .message-content {
	  background-color: #283f57;
	}
	
	.from-bot .message-content {
	  background-color: #1a1a1a;
	}
	
    
    #input-container {
      padding: 20px;
      border-top: 1px solid #e6e6e6;
	  
    }
    
    input[type="text"] {
      width: 98%;
      padding: 10px;
      border: 1px solid gray;
      border-radius: 5px;
      font-size: 14px;
	
    }
	
	textarea {
	  width: 98%;
	  padding: 10px;
	  border: 1px solid gray;
	  border-radius: 5px;
	  font-size: 14px;
	
	}
	
    
    button {
      width: 18%;
      padding: 10px;
      margin-left: 2%;
      background-color: #007aff;
      color: #ffffff;
      border: none;
      border-radius: 5px;
      font-size: 14px;
      cursor: pointer;
	  margin-bottom: 5px; /* 设置下方距离为 10px */
    }
    
    /* 媒体查询：在600像素以下的屏幕上，聊天框和输入框将占据100%宽度，并删除边距 */
    @media only screen and (max-width: 600px) {
      #chat-container {
        width: 100%;
        margin: 0;
        border-radius: 0;
      }
      
      #chat-header, #input-container {
        padding: 10px;
      }
      
      input[type="text"] {
        width: 70%;
      }
	  
	  textarea {
	    width: 70%;
	  }
      
      button {
        width: 28%;
        margin-left: 2%;
		margin-bottom: 5px; /* 设置下方距离为 10px */
      }
    }
  </style>
  
  
  <style>
        /* 定义全局变量 */
        :root {
          --bg-color: #363636;
          --text-color: #f2f2f2;
        }
  
        /* 设置背景颜色和文本颜色 */
        body,div,input,textarea {
          background-color: var(--bg-color);
          color: var(--text-color);
        }
		
  
        /* 修改链接文本颜色 */
        a {
          color: #ddd;
        }
        
        /* 修改按钮背景颜色 */
        button {
          background-color: #444;
          color: #fff;
        }
    </style>
</head>
<body>
	<div id="myModal" class="modal">
	  <div class="modal-content">
	    <div class="spinner"></div>
	    <p>请稍后...</p>
	  </div>
	</div>
  <div id="chat-container">
    <div id="chat-header">AI Chat</div>
    <div id="chat-messages"></div>
    <div id="input-container">
      <input style="display: none;" type="text" placeholder="请输入问题...">
	  <textarea  placeholder="请输入问题..."></textarea>
	  <hr>
  <button style="display: none;" id="send-button">接口1</button> 
<button id="send-button2">接口2</button>
<button id="clearBtn">清空历史</button>
<button id="saveBtn">下载记录</button>
<button id="importBtn">导入记录</button>
<input style="display: none;" type="file" id="importFile">
</div>
</div>
<footer style="text-align: center;"><a target="_blank" href="https://greasyfork.org/zh-CN/scripts/459997">@夜雨-2020-2023</a></footer>
</br>
<footer style="text-align: center;display: none;"><a target="_blank" href="https://wwcl.lanzouw.com/iK8Kh0rsxigd">APP下载</a></footer>
<footer style="text-align: center;"><a target="_blank" href="https://greasyfork.org/zh-CN/scripts/463138">脚本增强更新至v1.5 >新增接口</a></footer>
<script src="//cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/markdown-it/13.0.1/markdown-it.min.js"></script>
<script src="//cdn.jsdelivr.net/npm/showdown@2.1.0/dist/showdown.min.js"></script>
<script src="//cdn.jsdelivr.net/npm/marked@4.2.3/marked.min.js"></script>



<script>
const messagesContainer = document.getElementById("chat-messages");
const sendButton = document.getElementById("send-button");
const sendButton2 = document.getElementById("send-button2");
//const inputField = document.querySelector("#input-container input[type='text']");
const inputField = document.querySelector("#input-container textarea");


function saveHistory(humanMsg,botMsg){
	var chatList =  localStorage.getItem("chatList")
	if(chatList){
		chatList = JSON.parse(chatList)
		chatList.push({
			human: humanMsg,
			bot: botMsg
		})
		 localStorage.setItem("chatList",JSON.stringify(chatList))
	}else{
		chatList = []
		chatList.push({
			human: humanMsg,
			bot: botMsg
		})
		localStorage.setItem("chatList",JSON.stringify(chatList))
	}
}

function loadHistory(data){
	var chatList =  data ? data: localStorage.getItem("chatList")
	if(chatList){
		chatList = JSON.parse(chatList)
		chatList.forEach(function(item) {
		  //human
		  const newMessage = document.createElement("div");
		  const messageContent = document.createElement("div");
		  const useravatar = document.createElement("div");
		  useravatar.classList.add("message-avatar");
		  newMessage.classList.add("message", "from-user");
		  messageContent.classList.add("message-content");
		  messageContent.textContent = item.human;
		  newMessage.appendChild(useravatar)
		  newMessage.appendChild(messageContent);
		  messagesContainer.appendChild(newMessage);
		  
		  //bot
		  simulateBotResponse(item.bot)
		})
	}
}

function handleBot(question,type){
	let q = question;
	$("#chat-header").html("思考中，请稍后...")
	
	if(type == 1){
		$.ajax({
			method: "GET",
			url: "https://wenxin110.top/api/chat_gpt?text=" + encodeURI(q),
			headers: {
			},
			success: function(res) {
				//Save History
				try{
					saveHistory(question,res.text)
				}catch(e){
					//TODO handle the exception
				}
				simulateBotResponse(res.text)
				$("#chat-header").html("AI Chat")
				hideWait()
			},
			error:function(res){
				simulateBotResponse("未知错误...")
				hideWait()
			},
			timeout:(res)=>{
				hideWait()
				simulateBotResponse("超时...")
			}
		});
	}else if(type == 2){
		alert("此接口已G,请使用插件");
		$.ajax({
			method: "POST",
			url: "https://api.forchange.cn",
			headers: {
				"Content-Type": "application/json",
				Authorization: `Bearer `,
			},
			data: JSON.stringify({
				prompt: "Human:" + q + "\nAI:",
				tokensLength: q.length
			}),
			success: function(res) {
			
				let ans = res.choices[0].text.replace(/您当前访问的网页.*?的app/gi,"")
				.replace(/若您是站长.*?服务/gi,"")
				//Save History
				try{
					saveHistory(question,ans)
				}catch(e){
					//TODO handle the exception
				}
				simulateBotResponse(ans)
				
				$("#chat-header").html("AI Chat")
				hideWait()	
			},
			error:function(res){
				hideWait()
				simulateBotResponse("未知错误...")
			},
			timeout:(res)=>{
				hideWait()
				simulateBotResponse("超时...")
			}
		})
	}
	
	
}


// 模拟机器人回复
function simulateBotResponse(restMessage) {
  if(!restMessage) return
  const newMessage = document.createElement("div");
  const messageContent = document.createElement("article");
  const botavatar = document.createElement("div");
  botavatar.classList.add("message-avatar");
//  console.log(restMessage)
  newMessage.classList.add("message", "from-bot");
  messageContent.classList.add("message-content");
  messageContent.classList.add("markdown-body");
  messageContent.innerHTML = `${mdConverter(restMessage.replace(/\\n+/g,"\n"))}`;
  newMessage.appendChild(botavatar);
  newMessage.appendChild(messageContent);
  messagesContainer.appendChild(newMessage);
  
  // 初始化highlight.js
 // hljs.initHighlightingOnLoad();
  for (let i = 0; i <= document.getElementsByTagName("code").length -1; i++) {
  	//document.getElementsByTagName("code")[i].setAttribute("class",
  	//	"language-javascript hljs");
	document.getElementsByTagName("code")[i].classList.add("hljs");
  	hljs.highlightAll() 
  }
  
  
  // 将消息框滚动到底部，以便用户看到最新的回复
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// 处理用户输入的消息
function handleUserInput(type) {
  const messageText = inputField.value.trim();
  if (messageText) {
    const newMessage = document.createElement("div");
    const messageContent = document.createElement("div");
    const useravatar = document.createElement("div");
    useravatar.classList.add("message-avatar");
    newMessage.classList.add("message", "from-user");
    messageContent.classList.add("message-content");
    messageContent.textContent = messageText;
    newMessage.appendChild(useravatar)
    newMessage.appendChild(messageContent);
    messagesContainer.appendChild(newMessage);
    
    //simulateBotResponse(messageText);
	handleBot(messageText,type);
    
    // 清空输入框，准备下一次输入
    inputField.value = "";
    
    // 将消息框滚动到底部，以便用户看到最新的回复
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }
}

// 当用户按下回车键时，模拟点击发送按钮
inputField.addEventListener("keyup", function(event) {
   if (event.keyCode === 13) {
    event.preventDefault();
	let defaultbtn = document.getElementById("chatX")
	if(defaultbtn){
		defaultbtn.click()
		return
	}
    sendButton2.click();
  };

});

function showWait(){
	const modal = document.getElementById('myModal');
	modal.style.display = 'block';
}

function hideWait(){
	document.getElementById('myModal').style.display = 'none';
}

// 当用户点击发送按钮时，处理用户输入的消息
sendButton.addEventListener("click", ()=>{
	showWait()
	handleUserInput(1)
});

sendButton2.addEventListener("click", ()=>{
	showWait()
	handleUserInput(2)
});

document.getElementById("clearBtn").addEventListener("click",()=>{
	localStorage.removeItem("chatList")
	location.reload()
})

document.getElementById("saveBtn").addEventListener("click",()=>{
	console.log("----sava-----")
	const data = JSON.stringify(JSON.parse(localStorage.getItem("chatList")));
	const blob = new Blob([data], { type: 'application/json' });
	const url = window.URL.createObjectURL(blob);
	const link = document.createElement('a');
	link.href = url;
	link.download = 'chatList.json';
	link.click();
	setTimeout(() => {
	  console.log("revoke")
	  window.URL.revokeObjectURL(url);
	},10000);
	
})

document.getElementById("importBtn").addEventListener("click",()=>{
	document.getElementById("importFile").click()
})

//md start
function Uint8ArrayToString(fileData) {
		var dataString = "";
		for (var i = 0; i < fileData.length; i++) {
			dataString += String.fromCharCode(fileData[i]);
		}

		return dataString
	}

	function decodeUnicode(str) {
		str = str.replace(/\\/g, "%");
		//转换中文
		str = unescape(str);
		//将其他受影响的转换回原来
		str = str.replace(/%/g, "\\");
		//对网址的链接进行处理
		str = str.replace(/\\/g, "");
		return str;
	}

	function mdConverter(rawData) {
		var converter = new showdown.Converter(); //增加拓展table
		converter.setOption('tables',
			true); //启用表格选项。从showdown 1.2.0版开始，表支持已作为可选功能移入核心拓展，showdown.table.min.js扩展已被弃用
		var view = converter.makeHtml(rawData);
		return view;
	}
//md end

simulateBotResponse(`[油猴搜索插件](https://greasyfork.org/zh-CN/scripts/459997)`)
simulateBotResponse(`[加群:734403992](https://jq.qq.com/?_wv=1027&k=ggnUQKEn)`)
//simulateBotResponse(`[切换GPT版本](./chatgpt.html)`)
</script>

<script>
const importFile = document.getElementById('importFile');

importFile.addEventListener('change', (event) => {
  const file = event.target.files[0];

  const reader = new FileReader();

  reader.onload = (event) => {
    const data = event.target.result;
	let newChatList = JSON.parse(data)

    // 在这里处理解析后的数据

    console.log(data);
	loadHistory(data)
	//合并
	let oldChatList = JSON.parse(localStorage.getItem("chatList"))
	if(!oldChatList){
		localStorage.setItem("chatList",data)
	}else{
		localStorage.setItem("chatList",JSON.stringify(oldChatList.concat(newChatList)))
	}
  };

  reader.readAsText(file);
});
</script>


<!-- base64 -->
<script>
	var Base64 = {
	  // 转码表
	  table: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/',
	
	  // 加密
	  encode: function (str) {
	    var base64 = '';
	    var buffer = '';
	    var code = 0;
	    for (var i = 0, len = str.length; i < len; i += 3) {
	      buffer = str.charCodeAt(i) << 16 | (str.charCodeAt(i + 1) << 8) | str.charCodeAt(i + 2);
	      code = [
	        (buffer & 0xfc0000) >> 18,
	        (buffer & 0x3f000) >> 12,
	        (buffer & 0xfc0) >> 6,
	        buffer & 0x3f
	      ];
	      base64 += this.table[code[0]] + this.table[code[1]] + this.table[code[2]] + this.table[code[3]];
	    }
	    if (len % 3 == 1) {
	      base64 = base64.slice(0, -2) + '==';
	    } else if (len % 3 == 2) {
	      base64 = base64.slice(0, -1) + '=';
	    }
	    return base64;
	  },
	
	  // 解密
	  decode: function (str) {
	    var raw = '';
	    var buffer = '';
	    var code = 0;
	    for (var i = 0, len = str.length; i < len; i += 4) {
	      buffer = (this.table.indexOf(str.charAt(i)) << 18) | (this.table.indexOf(str.charAt(i + 1)) << 12) | (this.table.indexOf(str.charAt(i + 2)) << 6) | this.table.indexOf(str.charAt(i + 3));
	      code = [
	        (buffer & 0xff0000) >> 16,
	        (buffer & 0xff00) >> 8,
	        buffer & 0xff
	      ];
	      for (var j = 0; j < 3; j++) {
	        if (code[j]) {
	          raw += String.fromCharCode(code[j]);
	        }
	      }
	    }
	    if (str.charAt(len - 1) == '=') {
	      raw = raw.slice(0, -1);
	      if (str.charAt(len - 2) == '=') {
	        raw = raw.slice(0, -1);
	      }
	    }
	    return raw;
	  }
	};
</script>

<script>
	//刷新
	function gg() {
	
		var reurl = location.protocol + "//" + location.host + location.pathname + "?random=" + Math.random();
		//刷新缓存
	
		location.href = reurl;
	
	}
	if (!(location.href.indexOf("random") != -1)) {
		var reurl = location.protocol + "//" + location.host + location.pathname + "?random=" + Math.random();
		//刷新缓存
	
		location.href = reurl;
	}
	
	//载入历史
	setTimeout(loadHistory,1000)
	
	//setKey
	localStorage.setItem("myAIkey",Base64.decode("c2stZkR2bTRBNE9PNTVpUjEyeHRhenlUM0JsYmtGSlhZbHNudmZnbEoybENHbW9Fc21I"))
	console.log("aikey:"+localStorage.getItem("myAIkey"))
	setTimeout(()=>{
			let chatX = document.getElementById("chatX")
			
			if(!chatX && !localStorage.getItem("wtips")){
				let manualInput = confirm("检测到未使用油猴增加,是否使用增强?");
				if (manualInput) {
					localStorage.setItem("wtips",true)
				    location.href = "https://greasyfork.org/zh-CN/scripts/463138"
				}else{
					localStorage.setItem("wtips",true)
				}
			}
				
	},3000)
</script>
</body>
		<!-- 百度统计 -->
		<script>
			var _hmt = _hmt || [];
			(function() {
				var hm = document.createElement("script");
				hm.src = "https://hm.baidu.com/hm.js?4925a5b02da9504aab1a241aad222dfd";
				var s = document.getElementsByTagName("script")[0];
				s.parentNode.insertBefore(hm, s);
			})();
		</script>
</html>